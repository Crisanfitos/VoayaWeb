{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dibuj/Documents/Voaya/client/src/app/actions/chat-actions.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { GoogleGenerativeAI, GenerateContentResult } from \"@google/generative-ai\";\r\nimport { TravelBrief, TravelPlan, ChatMessage, GroundingAttribution } from '@/types';\r\n\r\nexport async function sendConversationToWebhook(brief: TravelBrief, webhookUrl = 'https://n8n.voaya.es/webhook-test/40e869f7-f18a-42e5-b16c-1b2e134660b8') {\r\n    try {\r\n        const params = new URLSearchParams();\r\n        params.append('initialQuery', brief.initialQuery ?? '');\r\n        params.append('chatHistory', JSON.stringify(brief.chatHistory.map((m: ChatMessage) => ({ role: m.role, text: m.text }))));\r\n        params.append('createdAt', new Date().toISOString());\r\n\r\n        const url = `${webhookUrl}?${params.toString()}`;\r\n        const res = await fetch(url, { method: 'GET' });\r\n\r\n        if (!res.ok) {\r\n            const text = await res.text().catch(() => '');\r\n            console.error('Webhook error', res.status, text);\r\n            throw new Error(`Webhook responded with status ${res.status}`);\r\n        }\r\n\r\n        const contentType = res.headers.get('content-type') || '';\r\n        if (contentType.includes('application/json')) {\r\n            return await res.json();\r\n        }\r\n        return null;\r\n    } catch (err) {\r\n        console.error('Error sending conversation to webhook:', err);\r\n        throw err;\r\n    }\r\n}\r\n\r\nexport const generatePlan = async (brief: TravelBrief, userLocation: GeolocationPosition | null): Promise<TravelPlan> => {\r\n    try {\r\n        await sendConversationToWebhook(brief);\r\n    } catch (err) {\r\n        console.warn('sendConversationToWebhook failed:', err);\r\n    }\r\n\r\n    const planGenerationModelName = 'gemini-1.5-pro';\r\n    const serverGenAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);\r\n    const planGenerationModel = serverGenAI.getGenerativeModel({ model: planGenerationModelName, tools: [{ googleSearch: {} } as any] });\r\n\r\n\r\n    const briefText = `Idea inicial: \"${brief.initialQuery}\".\\n\\nHistorial de la conversación:\\n${brief.chatHistory.map((m: ChatMessage) => `${m.role}: ${m.text}`).join('\\n')}`;\r\n\r\n    const prompt = `\r\nEres \"Cerebro IA\", un planificador de viajes experto. Tu tarea es crear un itinerario de viaje completo basado en el siguiente resumen del usuario:\\n${briefText}\\n\r\nDEBES usar tus herramientas googleSearch y googleMaps para recopilar información actualizada y del mundo real sobre vuelos, puntos de interés y logística.\r\n\r\nSigue estos pasos:\r\n1.  **Vuelos:** Encuentra las 2-3 mejores opciones de vuelo. Incluye un precio aproximado, aerolínea/escalas y un enlace directo a una búsqueda de Google Flights pre-rellenada para que el usuario reserve.\r\n2.  **Puntos de Interés (POIs):** Basado en los intereses del usuario, encuentra atracciones, actividades y lugares \"imperdibles\" relevantes.\r\n3.  **Itinerario:** Crea un itinerario lógico, día por día. Para cada día, describe las actividades y calcula tiempos de viaje realistas entre ubicaciones. Sugiere tipos de alojamiento.\r\n4.  **Enlace del Mapa:** Genera una URL de Google Maps que muestre la ruta con todos los POIs clave como puntos de referencia.\r\n\r\nTu resultado final DEBE ser un único objeto JSON encerrado en un bloque de código markdown (ej. \r\n\\`\\`\\`json ... \\`\\`\\`). No agregues ningún otro texto antes o después del bloque JSON. El objeto JSON debe seguir estrictamente este esquema:\r\n{\r\n  \"summary\": {\r\n    \"destination\": \"string\",\r\n    \"dates\": \"string\",\r\n    \"travelers\": \"string\",\r\n    \"style\": \"string\"\r\n  },\r\n  \"flights\": [\r\n    {\r\n      \"type\": \"string (e.g., 'Best Value', 'Fastest')\",\r\n      \"price\": \"string (e.g., '~€450')\",\r\n      \"details\": \"string (e.g., 'KLM, 1 stop in Amsterdam')\",\r\n      \"link\": \"string (URL)\"\r\n    }\r\n  ],\r\n  \"mapUrl\": \"string (Google Maps URL with waypoints)\",\r\n  \"itinerary\": [\r\n    {\r\n      \"day\": \"number\",\r\n      \"title\": \"string\",\r\n      \"morning\": \"string\",\r\n      \"afternoon\": \"string\",\r\n      \"evening\": \"string\",\r\n      \"accommodation\": \"string (e.g., 'Suggested Hotel in Flåm')\"\r\n    }\r\n  ]\r\n}\r\n`;\r\n\r\n    try {\r\n        const result: GenerateContentResult = await planGenerationModel.generateContent(prompt);\r\n        const response = result.response;\r\n        const text = response.text();\r\n        const jsonMatch = text.match(/```json\\n([\\s\\S]*?)\\n```/);\r\n        if (!jsonMatch || !jsonMatch[1]) {\r\n            throw new Error(\"Could not find a valid JSON block in the model's response.\");\r\n        }\r\n\r\n        const parsedPlan = JSON.parse(jsonMatch[1]) as Omit<TravelPlan, 'groundingAttribution'>;\r\n\r\n        const attributions: GroundingAttribution[] = response.candidates?.[0]?.citationMetadata?.citationSources.map((source: { uri?: string | null }) => ({\r\n            uri: source.uri ?? '',\r\n            title: '' // Title is not directly available in this structure\r\n        })) || [];\r\n\r\n\r\n        return { ...parsedPlan, groundingAttribution: attributions };\r\n\r\n    } catch (error) {\r\n        console.error(\"Error generating plan:\", error);\r\n        throw new Error(\"Failed to generate travel plan from the model.\");\r\n    }\r\n};\r\n"],"names":[],"mappings":";;;;;;AAEA;;;;;AAGO,eAAe,0BAA0B,KAAkB,EAAE,aAAa,wEAAwE;IACrJ,IAAI;QACA,MAAM,SAAS,IAAI;QACnB,OAAO,MAAM,CAAC,gBAAgB,MAAM,YAAY,IAAI;QACpD,OAAO,MAAM,CAAC,eAAe,KAAK,SAAS,CAAC,MAAM,WAAW,CAAC,GAAG,CAAC,CAAC,IAAmB,CAAC;gBAAE,MAAM,EAAE,IAAI;gBAAE,MAAM,EAAE,IAAI;YAAC,CAAC;QACrH,OAAO,MAAM,CAAC,aAAa,IAAI,OAAO,WAAW;QAEjD,MAAM,MAAM,GAAG,WAAW,CAAC,EAAE,OAAO,QAAQ,IAAI;QAChD,MAAM,MAAM,MAAM,MAAM,KAAK;YAAE,QAAQ;QAAM;QAE7C,IAAI,CAAC,IAAI,EAAE,EAAE;YACT,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM;YAC1C,QAAQ,KAAK,CAAC,iBAAiB,IAAI,MAAM,EAAE;YAC3C,MAAM,IAAI,MAAM,CAAC,8BAA8B,EAAE,IAAI,MAAM,EAAE;QACjE;QAEA,MAAM,cAAc,IAAI,OAAO,CAAC,GAAG,CAAC,mBAAmB;QACvD,IAAI,YAAY,QAAQ,CAAC,qBAAqB;YAC1C,OAAO,MAAM,IAAI,IAAI;QACzB;QACA,OAAO;IACX,EAAE,OAAO,KAAK;QACV,QAAQ,KAAK,CAAC,0CAA0C;QACxD,MAAM;IACV;AACJ;AAEO,MAAM,eAAe,OAAO,OAAoB;IACnD,IAAI;QACA,MAAM,0BAA0B;IACpC,EAAE,OAAO,KAAK;QACV,QAAQ,IAAI,CAAC,qCAAqC;IACtD;IAEA,MAAM,0BAA0B;IAChC,MAAM,cAAc,IAAI,8JAAA,CAAA,qBAAkB,CAAC,QAAQ,GAAG,CAAC,cAAc;IACrE,MAAM,sBAAsB,YAAY,kBAAkB,CAAC;QAAE,OAAO;QAAyB,OAAO;YAAC;gBAAE,cAAc,CAAC;YAAE;SAAS;IAAC;IAGlI,MAAM,YAAY,CAAC,eAAe,EAAE,MAAM,YAAY,CAAC,qCAAqC,EAAE,MAAM,WAAW,CAAC,GAAG,CAAC,CAAC,IAAmB,GAAG,EAAE,IAAI,CAAC,EAAE,EAAE,EAAE,IAAI,EAAE,EAAE,IAAI,CAAC,OAAO;IAE5K,MAAM,SAAS,CAAC;qJACiI,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAsCjK,CAAC;IAEG,IAAI;QACA,MAAM,SAAgC,MAAM,oBAAoB,eAAe,CAAC;QAChF,MAAM,WAAW,OAAO,QAAQ;QAChC,MAAM,OAAO,SAAS,IAAI;QAC1B,MAAM,YAAY,KAAK,KAAK,CAAC;QAC7B,IAAI,CAAC,aAAa,CAAC,SAAS,CAAC,EAAE,EAAE;YAC7B,MAAM,IAAI,MAAM;QACpB;QAEA,MAAM,aAAa,KAAK,KAAK,CAAC,SAAS,CAAC,EAAE;QAE1C,MAAM,eAAuC,SAAS,UAAU,EAAE,CAAC,EAAE,EAAE,kBAAkB,gBAAgB,IAAI,CAAC,SAAoC,CAAC;gBAC/I,KAAK,OAAO,GAAG,IAAI;gBACnB,OAAO,GAAG,oDAAoD;YAClE,CAAC,MAAM,EAAE;QAGT,OAAO;YAAE,GAAG,UAAU;YAAE,sBAAsB;QAAa;IAE/D,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,0BAA0B;QACxC,MAAM,IAAI,MAAM;IACpB;AACJ;;;IAzGsB;IA2BT;;AA3BS,+OAAA;AA2BT,+OAAA","debugId":null}},
    {"offset": {"line": 138, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dibuj/Documents/Voaya/client/src/app/actions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { ChatMessage } from '@/types';\r\n\r\ninterface ProcessResult {\r\n  success: boolean;\r\n  message: string;\r\n  data?: any;\r\n}\r\n\r\nexport async function processAndSendData(\r\n  history: ChatMessage[],\r\n  category: 'flights' | 'hotels' | 'experiences'\r\n): Promise<ProcessResult> {\r\n\r\n  switch (category) {\r\n    case 'flights':\r\n      try {\r\n        // Enviar el historial del chat al webhook de n8n para extracción de datos\r\n        console.log(\"Enviando historial del chat a n8n para extracción...\");\r\n\r\n        const webhookUrl = 'https://n8n.voaya.es/webhook/flight-search';\r\n        console.log(`Enviando datos a ${webhookUrl}...`);\r\n\r\n        const response = await fetch(webhookUrl, {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n          },\r\n          body: JSON.stringify({\r\n            chatHistory: history,\r\n            category: 'flights',\r\n            timestamp: new Date().toISOString(),\r\n          }),\r\n        });\r\n\r\n        if (!response.ok) {\r\n          const errorBody = await response.text();\r\n          console.error(`Error del webhook: ${response.status} ${response.statusText}`, errorBody);\r\n          return { success: false, message: `El servidor de Voaya respondió con un error: ${response.statusText}` };\r\n        }\r\n\r\n        const responseData = await response.json();\r\n        console.log(\"Respuesta del webhook:\", responseData);\r\n\r\n        return { success: true, message: \"¡Búsqueda de vuelos iniciada con éxito!\", data: responseData };\r\n\r\n      } catch (error) {\r\n        console.error(\"Error procesando la solicitud de vuelos:\", error);\r\n        const errorMessage = error instanceof Error ? error.message : \"Ocurrió un error desconocido.\";\r\n        return { success: false, message: `Error interno: ${errorMessage}` };\r\n      }\r\n\r\n    case 'hotels':\r\n      // TODO: Implementar lógica para hoteles\r\n      console.log(\"Procesamiento para 'hoteles' aún no implementado.\");\r\n      return { success: false, message: \"La categoría 'hoteles' aún no está implementada.\" };\r\n\r\n    case 'experiences':\r\n      // TODO: Implementar lógica para experiencias\r\n      console.log(\"Procesamiento para 'experiencias' aún no implementado.\");\r\n      return { success: false, message: \"La categoría 'experiencias' aún no está implementada.\" };\r\n\r\n    default:\r\n      console.warn(`Categoría desconocida: ${category}`);\r\n      return { success: false, message: `La categoría '${category}' no es válida.` };\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAUO,eAAe,mBACpB,OAAsB,EACtB,QAA8C;IAG9C,OAAQ;QACN,KAAK;YACH,IAAI;gBACF,0EAA0E;gBAC1E,QAAQ,GAAG,CAAC;gBAEZ,MAAM,aAAa;gBACnB,QAAQ,GAAG,CAAC,CAAC,iBAAiB,EAAE,WAAW,GAAG,CAAC;gBAE/C,MAAM,WAAW,MAAM,MAAM,YAAY;oBACvC,QAAQ;oBACR,SAAS;wBACP,gBAAgB;oBAClB;oBACA,MAAM,KAAK,SAAS,CAAC;wBACnB,aAAa;wBACb,UAAU;wBACV,WAAW,IAAI,OAAO,WAAW;oBACnC;gBACF;gBAEA,IAAI,CAAC,SAAS,EAAE,EAAE;oBAChB,MAAM,YAAY,MAAM,SAAS,IAAI;oBACrC,QAAQ,KAAK,CAAC,CAAC,mBAAmB,EAAE,SAAS,MAAM,CAAC,CAAC,EAAE,SAAS,UAAU,EAAE,EAAE;oBAC9E,OAAO;wBAAE,SAAS;wBAAO,SAAS,CAAC,6CAA6C,EAAE,SAAS,UAAU,EAAE;oBAAC;gBAC1G;gBAEA,MAAM,eAAe,MAAM,SAAS,IAAI;gBACxC,QAAQ,GAAG,CAAC,0BAA0B;gBAEtC,OAAO;oBAAE,SAAS;oBAAM,SAAS;oBAA2C,MAAM;gBAAa;YAEjG,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,4CAA4C;gBAC1D,MAAM,eAAe,iBAAiB,QAAQ,MAAM,OAAO,GAAG;gBAC9D,OAAO;oBAAE,SAAS;oBAAO,SAAS,CAAC,eAAe,EAAE,cAAc;gBAAC;YACrE;QAEF,KAAK;YACH,wCAAwC;YACxC,QAAQ,GAAG,CAAC;YACZ,OAAO;gBAAE,SAAS;gBAAO,SAAS;YAAmD;QAEvF,KAAK;YACH,6CAA6C;YAC7C,QAAQ,GAAG,CAAC;YACZ,OAAO;gBAAE,SAAS;gBAAO,SAAS;YAAwD;QAE5F;YACE,QAAQ,IAAI,CAAC,CAAC,uBAAuB,EAAE,UAAU;YACjD,OAAO;gBAAE,SAAS;gBAAO,SAAS,CAAC,cAAc,EAAE,SAAS,eAAe,CAAC;YAAC;IACjF;AACF;;;IAzDsB;;AAAA,+OAAA","debugId":null}},
    {"offset": {"line": 221, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dibuj/Documents/Voaya/client/.next-internal/server/app/plan/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {generatePlan as '7ff68d4732d783905755fa3c43c518e55a123ff443'} from 'ACTIONS_MODULE0'\nexport {processAndSendData as '609cc85fb48e2475aae358a0263cfba6db8de3cf03'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AACA","debugId":null}},
    {"offset": {"line": 285, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dibuj/Documents/Voaya/client/src/app/plan/page.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/client/src/app/plan/page.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/client/src/app/plan/page.tsx <module evaluation>\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAAgS,GAC7T,8DACA","debugId":null}},
    {"offset": {"line": 299, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dibuj/Documents/Voaya/client/src/app/plan/page.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/client/src/app/plan/page.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/client/src/app/plan/page.tsx\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAA4Q,GACzS,0CACA","debugId":null}},
    {"offset": {"line": 313, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}}]
}