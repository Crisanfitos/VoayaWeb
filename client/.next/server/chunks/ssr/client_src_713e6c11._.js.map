{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dibuj/Documents/Voaya/client/src/components/ui/loader.tsx"],"sourcesContent":["\r\nexport function Loader() {\r\n  return (\r\n    <svg\r\n      className=\"animate-spin h-12 w-12 text-primary\"\r\n      xmlns=\"http://www.w3.org/2000/svg\"\r\n      fill=\"none\"\r\n      viewBox=\"0 0 24 24\"\r\n    >\r\n      <circle\r\n        className=\"opacity-25\"\r\n        cx=\"12\"\r\n        cy=\"12\"\r\n        r=\"10\"\r\n        stroke=\"currentColor\"\r\n        strokeWidth=\"4\"\r\n      ></circle>\r\n      <path\r\n        className=\"opacity-75\"\r\n        fill=\"currentColor\"\r\n        d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\r\n      ></path>\r\n    </svg>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AACO,SAAS;IACd,qBACE,8OAAC;QACC,WAAU;QACV,OAAM;QACN,MAAK;QACL,SAAQ;;0BAER,8OAAC;gBACC,WAAU;gBACV,IAAG;gBACH,IAAG;gBACH,GAAE;gBACF,QAAO;gBACP,aAAY;;;;;;0BAEd,8OAAC;gBACC,WAAU;gBACV,MAAK;gBACL,GAAE;;;;;;;;;;;;AAIV","debugId":null}},
    {"offset": {"line": 53, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dibuj/Documents/Voaya/client/src/components/ui/input.tsx"],"sourcesContent":["import * as React from \"react\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\r\n  ({ className, type, ...props }, ref) => {\r\n    return (\r\n      <input\r\n        type={type}\r\n        className={cn(\r\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\r\n          className\r\n        )}\r\n        ref={ref}\r\n        {...props}\r\n      />\r\n    )\r\n  }\r\n)\r\nInput.displayName = \"Input\"\r\n\r\nexport { Input }\r\n"],"names":[],"mappings":";;;;AAAA;AAEA;;;;AAEA,MAAM,sBAAQ,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAC3B,CAAC,EAAE,SAAS,EAAE,IAAI,EAAE,GAAG,OAAO,EAAE;IAC9B,qBACE,8OAAC;QACC,MAAM;QACN,WAAW,CAAA,GAAA,6HAAA,CAAA,KAAE,AAAD,EACV,kYACA;QAEF,KAAK;QACJ,GAAG,KAAK;;;;;;AAGf;AAEF,MAAM,WAAW,GAAG","debugId":null}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dibuj/Documents/Voaya/client/src/config/api.ts"],"sourcesContent":["// Usar variable de entorno o detectar dinámicamente\r\nexport const getApiUrl = (): string => {\r\n    // Primero intenta usar la variable de entorno para flexibilidad\r\n    if (process.env.NEXT_PUBLIC_API_URL) {\r\n        return process.env.NEXT_PUBLIC_API_URL;\r\n    }\r\n\r\n    // En el lado del servidor (SSR) o en desarrollo local, apunta a localhost\r\n    if (typeof window === 'undefined' || window.location.hostname === 'localhost') {\r\n        return 'http://localhost:3001';\r\n    }\r\n\r\n    // En producción (cuando se accede a través de un dominio), usa una ruta relativa\r\n    // para que las peticiones se dirijan al mismo host que sirve la app Next.js.\r\n    // Next.js se encargará de actuar como proxy para estas peticiones.\r\n    return '/api';\r\n};\r\n\r\nexport const API_URL = getApiUrl();\r\n\r\n\r\n\r\nconsole.log('[API Config] API_URL:', API_URL);\r\n"],"names":[],"mappings":"AAAA,oDAAoD;;;;;AAC7C,MAAM,YAAY;IACrB,gEAAgE;IAChE,IAAI,QAAQ,GAAG,CAAC,mBAAmB,EAAE;QACjC,OAAO,QAAQ,GAAG,CAAC,mBAAmB;IAC1C;IAEA,0EAA0E;IAC1E,wCAA+E;QAC3E,OAAO;IACX;;AAMJ;AAEO,MAAM,UAAU;AAIvB,QAAQ,GAAG,CAAC,yBAAyB","debugId":null}},
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dibuj/Documents/Voaya/client/src/services/api.ts"],"sourcesContent":["import { ChatMessage, TravelBrief, TravelPlan } from '@/types';\r\nimport { API_URL } from '@/config/api';\r\n\r\nexport class ApiService {\r\n    private static async fetchApi(endpoint: string, options: RequestInit = {}) {\r\n        const url = `${API_URL}${endpoint}`;\r\n        try {\r\n            console.log(`[ApiService] Fetching ${url}`, { method: options.method });\r\n\r\n            const response = await fetch(url, {\r\n                ...options,\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    ...options.headers,\r\n                },\r\n            });\r\n\r\n            console.log(`[ApiService] Response received with status: ${response.status}`);\r\n\r\n            if (!response.ok) {\r\n                const errorText = await response.text();\r\n                console.error(`[ApiService] API error: ${response.status}`, errorText);\r\n                throw new Error(`API error: ${response.status} - ${errorText}`);\r\n            }\r\n\r\n            const responseText = await response.text();\r\n            console.log(`[ApiService] Raw response text:`, responseText);\r\n\r\n            try {\r\n                const data = JSON.parse(responseText);\r\n                console.log(`[ApiService] Parsed response:`, data);\r\n                return data;\r\n            } catch (error) {\r\n                console.error(`[ApiService] Error parsing JSON:`, error);\r\n                // Si el parseo falla, pero la respuesta fue exitosa (ej. 204 No Content),\r\n                // podríamos devolver un objeto vacío o el texto plano si es necesario.\r\n                return { success: true, data: responseText };\r\n            }\r\n        } catch (error: any) {\r\n            console.error(`[ApiService] Fetch error:`, error);\r\n            throw error;\r\n        }\r\n    } static async startChat(userId: string, categories: string[] = []) {\r\n        return this.fetchApi('/chat/start', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ userId, categories }),\r\n        });\r\n    }\r\n\r\n    static async sendMessage(chatId: string, text: string, userId: string) {\r\n        return this.fetchApi('/chat/message', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ chatId, text, userId }),\r\n        });\r\n    }\r\n\r\n    static async completeChat(chatId: string) {\r\n        return this.fetchApi('/chat/complete', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ chatId }),\r\n        });\r\n    }\r\n\r\n    static async getChats(userId?: string) {\r\n        const qs = userId ? `?userId=${encodeURIComponent(userId)}` : '';\r\n        return this.fetchApi(`/chat${qs}`, {\r\n            method: 'GET'\r\n        });\r\n    }\r\n\r\n    static async getChat(chatId: string) {\r\n        if (!chatId) throw new Error('chatId required');\r\n        return this.fetchApi(`/chat/${encodeURIComponent(chatId)}`, {\r\n            method: 'GET'\r\n        });\r\n    }\r\n\r\n    static async sendToExternal(chatId: string, webhookUrl?: string) {\r\n        return this.fetchApi('/chat/send-external', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ chatId, webhookUrl }),\r\n        });\r\n    }\r\n\r\n    static async generatePlan(brief: TravelBrief, userLocation: GeolocationPosition | null) {\r\n        return this.fetchApi('/chat/generate-plan', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ brief, userLocation }),\r\n        }) as Promise<TravelPlan>;\r\n    }\r\n}"],"names":[],"mappings":";;;AACA;;AAEO,MAAM;IACT,aAAqB,SAAS,QAAgB,EAAE,UAAuB,CAAC,CAAC,EAAE;QACvE,MAAM,MAAM,GAAG,8HAAA,CAAA,UAAO,GAAG,UAAU;QACnC,IAAI;YACA,QAAQ,GAAG,CAAC,CAAC,sBAAsB,EAAE,KAAK,EAAE;gBAAE,QAAQ,QAAQ,MAAM;YAAC;YAErE,MAAM,WAAW,MAAM,MAAM,KAAK;gBAC9B,GAAG,OAAO;gBACV,SAAS;oBACL,gBAAgB;oBAChB,GAAG,QAAQ,OAAO;gBACtB;YACJ;YAEA,QAAQ,GAAG,CAAC,CAAC,4CAA4C,EAAE,SAAS,MAAM,EAAE;YAE5E,IAAI,CAAC,SAAS,EAAE,EAAE;gBACd,MAAM,YAAY,MAAM,SAAS,IAAI;gBACrC,QAAQ,KAAK,CAAC,CAAC,wBAAwB,EAAE,SAAS,MAAM,EAAE,EAAE;gBAC5D,MAAM,IAAI,MAAM,CAAC,WAAW,EAAE,SAAS,MAAM,CAAC,GAAG,EAAE,WAAW;YAClE;YAEA,MAAM,eAAe,MAAM,SAAS,IAAI;YACxC,QAAQ,GAAG,CAAC,CAAC,+BAA+B,CAAC,EAAE;YAE/C,IAAI;gBACA,MAAM,OAAO,KAAK,KAAK,CAAC;gBACxB,QAAQ,GAAG,CAAC,CAAC,6BAA6B,CAAC,EAAE;gBAC7C,OAAO;YACX,EAAE,OAAO,OAAO;gBACZ,QAAQ,KAAK,CAAC,CAAC,gCAAgC,CAAC,EAAE;gBAClD,0EAA0E;gBAC1E,uEAAuE;gBACvE,OAAO;oBAAE,SAAS;oBAAM,MAAM;gBAAa;YAC/C;QACJ,EAAE,OAAO,OAAY;YACjB,QAAQ,KAAK,CAAC,CAAC,yBAAyB,CAAC,EAAE;YAC3C,MAAM;QACV;IACJ;IAAE,aAAa,UAAU,MAAc,EAAE,aAAuB,EAAE,EAAE;QAChE,OAAO,IAAI,CAAC,QAAQ,CAAC,eAAe;YAChC,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;gBAAE;gBAAQ;YAAW;QAC9C;IACJ;IAEA,aAAa,YAAY,MAAc,EAAE,IAAY,EAAE,MAAc,EAAE;QACnE,OAAO,IAAI,CAAC,QAAQ,CAAC,iBAAiB;YAClC,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;gBAAE;gBAAQ;gBAAM;YAAO;QAChD;IACJ;IAEA,aAAa,aAAa,MAAc,EAAE;QACtC,OAAO,IAAI,CAAC,QAAQ,CAAC,kBAAkB;YACnC,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;gBAAE;YAAO;QAClC;IACJ;IAEA,aAAa,SAAS,MAAe,EAAE;QACnC,MAAM,KAAK,SAAS,CAAC,QAAQ,EAAE,mBAAmB,SAAS,GAAG;QAC9D,OAAO,IAAI,CAAC,QAAQ,CAAC,CAAC,KAAK,EAAE,IAAI,EAAE;YAC/B,QAAQ;QACZ;IACJ;IAEA,aAAa,QAAQ,MAAc,EAAE;QACjC,IAAI,CAAC,QAAQ,MAAM,IAAI,MAAM;QAC7B,OAAO,IAAI,CAAC,QAAQ,CAAC,CAAC,MAAM,EAAE,mBAAmB,SAAS,EAAE;YACxD,QAAQ;QACZ;IACJ;IAEA,aAAa,eAAe,MAAc,EAAE,UAAmB,EAAE;QAC7D,OAAO,IAAI,CAAC,QAAQ,CAAC,uBAAuB;YACxC,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;gBAAE;gBAAQ;YAAW;QAC9C;IACJ;IAEA,aAAa,aAAa,KAAkB,EAAE,YAAwC,EAAE;QACpF,OAAO,IAAI,CAAC,QAAQ,CAAC,uBAAuB;YACxC,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;gBAAE;gBAAO;YAAa;QAC/C;IACJ;AACJ","debugId":null}},
    {"offset": {"line": 215, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dibuj/Documents/Voaya/client/src/components/chat/chat-view.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport React, { useState, useEffect, useRef, useCallback } from 'react';\r\nimport { ChatMessage, TravelBrief } from '@/types';\r\nimport { ApiService } from '@/services/api';\r\nimport { ChatHeader } from './chat-header';\r\nimport { ChatMessages } from './chat-messages';\r\nimport { ChatInput } from './chat-input';\r\nimport { ChatCompletionControls } from './chat-completion-controls';\r\nimport { getUserIdFromCookie, getChatIdFromCookie, saveChatIdToCookie } from '@/lib/cookies';\r\n\r\ntype SearchCategory = 'flights' | 'hotels' | 'experiences';\r\n\r\ninterface ChatViewProps {\r\n  onChatComplete: (brief: TravelBrief) => void;\r\n  error: string | null;\r\n  initialQuery?: string;\r\n  selectedCategories?: Set<SearchCategory>;\r\n  userId?: string;\r\n  chatId?: string;\r\n  initialMessages?: ChatMessage[];\r\n  initialStatus?: string;\r\n}\r\n\r\nconst ChatView: React.FC<ChatViewProps> = ({ onChatComplete, error, initialQuery, selectedCategories, initialMessages, initialStatus }) => {\r\n  const [messages, setMessages] = useState<ChatMessage[]>(() => initialMessages || []);\r\n  const [input, setInput] = useState('');\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [isChatComplete, setIsChatComplete] = useState(!!initialStatus && initialStatus === 'completed');\r\n  const [internalInitialQuery, setInternalInitialQuery] = useState(initialQuery || '');\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const initialMessageSent = useRef(false);\r\n\r\n  // Get userId and chatId from cookies\r\n  const userId = getUserIdFromCookie();\r\n  const chatId = getChatIdFromCookie();\r\n\r\n  // Log initial status for debugging and detect if chat should show completion buttons\r\n  useEffect(() => {\r\n    console.log('[ChatView] Initialized with initialStatus:', initialStatus);\r\n    console.log('[ChatView] Initial messages count:', messages.length);\r\n    \r\n    // Show completion buttons if:\r\n    // 1. Status is 'completed' or 'finished', OR\r\n    // 2. Status is 'active' and there are messages (chat has content)\r\n    const shouldShowComplete = \r\n      initialStatus && \r\n      (initialStatus === 'completed' || \r\n       initialStatus === 'finished' || \r\n       (initialStatus === 'active' && messages.length > 0));\r\n    \r\n    console.log('[ChatView] shouldShowComplete:', shouldShowComplete);\r\n    if (shouldShowComplete && !isChatComplete) {\r\n      setIsChatComplete(true);\r\n    }\r\n  }, [initialStatus, messages.length, isChatComplete]);\r\n\r\n  const sendMessage = useCallback(async (text: string) => {\r\n    console.log(`[ChatView] sendMessage called with: \"${text}\"`);\r\n    console.log(`[ChatView] userId: ${userId}, chatId: ${chatId}`);\r\n\r\n    if (!userId || !chatId) {\r\n      console.error('[ChatView] Missing userId or chatId from cookies');\r\n      setMessages(prev => [...prev, {\r\n        role: 'assistant',\r\n        text: \"Error: No se pudo identificar tu sesión. Por favor, inicia sesión de nuevo.\"\r\n      }]);\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      console.log(`[ChatView] Calling ApiService.sendMessage...`);\r\n      const response = await ApiService.sendMessage(chatId, text, userId);\r\n      console.log(`[ChatView] Received response from API:`, response);\r\n\r\n      if (!response.message || typeof response.message.text !== 'string') {\r\n        console.error('[ChatView] Invalid response structure:', response);\r\n        throw new Error('Invalid response structure from server');\r\n      }\r\n\r\n      const modelMessage: ChatMessage = {\r\n        role: 'assistant',\r\n        text: response.message.text\r\n      };\r\n\r\n      console.log(`[ChatView] Updating messages state with new message...`);\r\n      setMessages(prev => {\r\n        const newMessages = [...prev, modelMessage];\r\n        console.log(`[ChatView] New messages state:`, newMessages);\r\n        return newMessages;\r\n      });\r\n\r\n      // Check if chat should be marked as complete based on the assistant's message\r\n      if (modelMessage.text.includes(\"ya tengo una base muy sólida para empezar a buscar\")) {\r\n        console.log(`[ChatView] Chat completion detected from Gemini response.`);\r\n        setIsChatComplete(true);\r\n      }\r\n    } catch (err) {\r\n      console.error(`[ChatView] Error calling API:`, err);\r\n      setMessages(prev => [...prev, {\r\n        role: 'assistant',\r\n        text: \"Lo siento, estoy teniendo problemas para conectarme. Por favor, inténtalo de nuevo.\"\r\n      }]);\r\n    } finally {\r\n      console.log(`[ChatView] sendMessage finished.`);\r\n      setIsLoading(false);\r\n    }\r\n  }, [selectedCategories]);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!input.trim() || isLoading) return;\r\n\r\n    const userMessage: ChatMessage = {\r\n      role: 'user',\r\n      text: input\r\n    };\r\n\r\n    setMessages(prev => [...prev, userMessage]);\r\n    const currentInput = input;\r\n    setInput('');\r\n\r\n    if (!internalInitialQuery) {\r\n      setInternalInitialQuery(currentInput);\r\n    }\r\n\r\n    await sendMessage(currentInput);\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (initialQuery && !initialMessageSent.current) {\r\n      const userMessage: ChatMessage = {\r\n        role: 'user',\r\n        text: initialQuery\r\n      };\r\n      setMessages([userMessage]);\r\n      setInternalInitialQuery(initialQuery);\r\n      sendMessage(initialQuery);\r\n      initialMessageSent.current = true;\r\n    }\r\n  }, [initialQuery, sendMessage]);\r\n\r\n  const handleConfirm = async () => {\r\n    // Mark chat as completed before redirecting\r\n    if (chatId) {\r\n      try {\r\n        console.log('[ChatView] Marking chat as completed...');\r\n        await ApiService.completeChat(chatId);\r\n        console.log('[ChatView] Chat marked as completed');\r\n      } catch (err) {\r\n        console.error('[ChatView] Error completing chat:', err);\r\n      }\r\n    }\r\n    // Reload the planner page\r\n    window.location.href = '/plan';\r\n  };\r\n\r\n  const handleRestart = () => {\r\n    setMessages([]);\r\n    setInput('');\r\n    setIsLoading(false);\r\n    setIsChatComplete(false);\r\n    setInternalInitialQuery('');\r\n  };\r\n\r\n  return (\r\n    <div className=\"container max-w-4xl mx-auto flex flex-col min-h-[700px] bg-gradient-to-b from-white to-gray-50/80 rounded-3xl shadow-xl overflow-hidden border border-gray-100/80\">\r\n      <div className=\"py-8 px-8 bg-white border-b border-gray-100/80\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"space-y-1\">\r\n            <h1 className=\"text-2xl font-semibold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent\">\r\n              Tu próxima aventura te espera ✈️\r\n            </h1>\r\n            <p className=\"text-sm text-gray-500\">Charlemos sobre tu próximo viaje</p>\r\n          </div>\r\n          <div className=\"flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-full border border-gray-100/80\">\r\n            <div className=\"w-2 h-2 rounded-full bg-green-400 animate-pulse\"></div>\r\n            <span className=\"text-sm text-gray-600 font-medium\">Voaya está activa</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {error && (\r\n        <div className=\"px-8 py-3 bg-red-50 border-b border-red-100 text-red-600 text-center text-sm font-medium\">\r\n          {error}\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"flex-1 overflow-y-auto px-8 py-8 space-y-8\">\r\n        {messages.map((msg, index) => (\r\n          <div\r\n            key={index}\r\n            className={`flex items-end gap-4 ${msg.role === 'user' ? 'justify-end' : 'justify-start'} animate-slideIn`}\r\n          >\r\n            {msg.role === 'assistant' && (\r\n              <div className=\"w-12 h-12 rounded-full bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center text-white font-bold text-lg shadow-inner flex-shrink-0 border-2 border-white\">\r\n                V\r\n              </div>\r\n            )}\r\n            <div\r\n              className={`\r\n                group max-w-[80%] px-6 py-4 rounded-2xl transition-all duration-200\r\n                ${msg.role === 'user'\r\n                  ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-br-sm shadow-lg hover:shadow-xl hover:-translate-y-0.5'\r\n                  : 'bg-white text-gray-700 rounded-bl-sm shadow-md hover:shadow-lg hover:-translate-y-0.5 border border-gray-100'\r\n                }\r\n              `}\r\n            >\r\n              <p className=\"text-[15px] leading-relaxed whitespace-pre-wrap\">{msg.text}</p>\r\n            </div>\r\n          </div>\r\n        ))}\r\n\r\n        {isLoading && (\r\n          <div className=\"flex items-end gap-4 justify-start animate-slideIn\">\r\n            <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center text-white font-bold text-lg shadow-inner flex-shrink-0 border-2 border-white\">\r\n              V\r\n            </div>\r\n            <div className=\"max-w-[80%] px-5 py-4 rounded-2xl bg-white shadow-md border border-gray-100 rounded-bl-sm\">\r\n              <div className=\"flex items-center space-x-2\">\r\n                <div className=\"w-2.5 h-2.5 rounded-full bg-blue-500 animate-bounce\"></div>\r\n                <div className=\"w-2.5 h-2.5 rounded-full bg-blue-500 animate-bounce [animation-delay:0.2s]\"></div>\r\n                <div className=\"w-2.5 h-2.5 rounded-full bg-blue-500 animate-bounce [animation-delay:0.4s]\"></div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n        <div ref={messagesEndRef} />\r\n      </div>\r\n\r\n      <div className=\"p-8 bg-white border-t border-gray-100/80\">\r\n        {isChatComplete ? (\r\n          <div className=\"flex items-center justify-center gap-6\">\r\n            <button\r\n              onClick={handleRestart}\r\n              className=\"px-8 py-4 rounded-full bg-gray-50 text-gray-700 font-medium hover:bg-gray-100 transition-all duration-300 transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-gray-200 focus:ring-offset-2 shadow-sm hover:shadow\"\r\n            >\r\n              Reiniciar Chat\r\n            </button>\r\n            <button\r\n              onClick={handleConfirm}\r\n              className=\"px-10 py-4 rounded-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-medium hover:from-blue-700 hover:to-indigo-700 transition-all duration-300 transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-md hover:shadow-lg\"\r\n            >\r\n              Confirmar y Buscar\r\n            </button>\r\n          </div>\r\n        ) : (\r\n          <form onSubmit={handleSubmit} className=\"flex items-center gap-4\">\r\n            <div className=\"relative flex-1\">\r\n              <input\r\n                type=\"text\"\r\n                value={input}\r\n                onChange={(e) => setInput(e.target.value)}\r\n                placeholder=\"Ej.: París, 2 personas, mayo...\"\r\n                className=\"w-full px-6 py-4 bg-gray-50 text-gray-800 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 placeholder:text-gray-400 shadow-sm hover:shadow-md\"\r\n                disabled={isLoading}\r\n              />\r\n            </div>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={isLoading || !input.trim()}\r\n              className=\"p-4 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white hover:from-blue-700 hover:to-indigo-700 disabled:from-gray-300 disabled:to-gray-300 disabled:cursor-not-allowed transition-all duration-300 transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-md hover:shadow-lg\"\r\n            >\r\n              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-6 w-6\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\r\n                <path d=\"M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z\" />\r\n              </svg>\r\n            </button>\r\n          </form>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ChatView;\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 651, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dibuj/Documents/Voaya/client/src/app/actions/chat-actions.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { GoogleGenerativeAI, GenerateContentResult } from \"@google/generative-ai\";\r\nimport { TravelBrief, TravelPlan, ChatMessage, GroundingAttribution } from '@/types';\r\n\r\nexport async function sendConversationToWebhook(brief: TravelBrief, webhookUrl = 'https://n8n.voaya.es/webhook-test/40e869f7-f18a-42e5-b16c-1b2e134660b8') {\r\n    try {\r\n        const params = new URLSearchParams();\r\n        params.append('initialQuery', brief.initialQuery ?? '');\r\n        params.append('chatHistory', JSON.stringify(brief.chatHistory.map((m: ChatMessage) => ({ role: m.role, text: m.text }))));\r\n        params.append('createdAt', new Date().toISOString());\r\n\r\n        const url = `${webhookUrl}?${params.toString()}`;\r\n        const res = await fetch(url, { method: 'GET' });\r\n\r\n        if (!res.ok) {\r\n            const text = await res.text().catch(() => '');\r\n            console.error('Webhook error', res.status, text);\r\n            throw new Error(`Webhook responded with status ${res.status}`);\r\n        }\r\n\r\n        const contentType = res.headers.get('content-type') || '';\r\n        if (contentType.includes('application/json')) {\r\n            return await res.json();\r\n        }\r\n        return null;\r\n    } catch (err) {\r\n        console.error('Error sending conversation to webhook:', err);\r\n        throw err;\r\n    }\r\n}\r\n\r\nexport const generatePlan = async (brief: TravelBrief, userLocation: GeolocationPosition | null): Promise<TravelPlan> => {\r\n    try {\r\n        await sendConversationToWebhook(brief);\r\n    } catch (err) {\r\n        console.warn('sendConversationToWebhook failed:', err);\r\n    }\r\n\r\n    const planGenerationModelName = 'gemini-1.5-pro';\r\n    const serverGenAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);\r\n    const planGenerationModel = serverGenAI.getGenerativeModel({ model: planGenerationModelName, tools: [{ googleSearch: {} }] });\r\n\r\n\r\n    const briefText = `Idea inicial: \"${brief.initialQuery}\".\\n\\nHistorial de la conversación:\\n${brief.chatHistory.map((m: ChatMessage) => `${m.role}: ${m.text}`).join('\\n')}`;\r\n\r\n    const prompt = `\r\nEres \"Cerebro IA\", un planificador de viajes experto. Tu tarea es crear un itinerario de viaje completo basado en el siguiente resumen del usuario:\\n${briefText}\\n\r\nDEBES usar tus herramientas googleSearch y googleMaps para recopilar información actualizada y del mundo real sobre vuelos, puntos de interés y logística.\r\n\r\nSigue estos pasos:\r\n1.  **Vuelos:** Encuentra las 2-3 mejores opciones de vuelo. Incluye un precio aproximado, aerolínea/escalas y un enlace directo a una búsqueda de Google Flights pre-rellenada para que el usuario reserve.\r\n2.  **Puntos de Interés (POIs):** Basado en los intereses del usuario, encuentra atracciones, actividades y lugares \"imperdibles\" relevantes.\r\n3.  **Itinerario:** Crea un itinerario lógico, día por día. Para cada día, describe las actividades y calcula tiempos de viaje realistas entre ubicaciones. Sugiere tipos de alojamiento.\r\n4.  **Enlace del Mapa:** Genera una URL de Google Maps que muestre la ruta con todos los POIs clave como puntos de referencia.\r\n\r\nTu resultado final DEBE ser un único objeto JSON encerrado en un bloque de código markdown (ej. \r\n\\`\\`\\`json ... \\`\\`\\`). No agregues ningún otro texto antes o después del bloque JSON. El objeto JSON debe seguir estrictamente este esquema:\r\n{\r\n  \"summary\": {\r\n    \"destination\": \"string\",\r\n    \"dates\": \"string\",\r\n    \"travelers\": \"string\",\r\n    \"style\": \"string\"\r\n  },\r\n  \"flights\": [\r\n    {\r\n      \"type\": \"string (e.g., 'Best Value', 'Fastest')\",\r\n      \"price\": \"string (e.g., '~€450')\",\r\n      \"details\": \"string (e.g., 'KLM, 1 stop in Amsterdam')\",\r\n      \"link\": \"string (URL)\"\r\n    }\r\n  ],\r\n  \"mapUrl\": \"string (Google Maps URL with waypoints)\",\r\n  \"itinerary\": [\r\n    {\r\n      \"day\": \"number\",\r\n      \"title\": \"string\",\r\n      \"morning\": \"string\",\r\n      \"afternoon\": \"string\",\r\n      \"evening\": \"string\",\r\n      \"accommodation\": \"string (e.g., 'Suggested Hotel in Flåm')\"\r\n    }\r\n  ]\r\n}\r\n`;\r\n\r\n    try {\r\n        const result: GenerateContentResult = await planGenerationModel.generateContent(prompt);\r\n        const response = result.response;\r\n        const text = response.text();\r\n        const jsonMatch = text.match(/```json\\n([\\s\\S]*?)\\n```/);\r\n        if (!jsonMatch || !jsonMatch[1]) {\r\n            throw new Error(\"Could not find a valid JSON block in the model's response.\");\r\n        }\r\n\r\n        const parsedPlan = JSON.parse(jsonMatch[1]) as Omit<TravelPlan, 'groundingAttribution'>;\r\n\r\n        const attributions: GroundingAttribution[] = response.candidates?.[0]?.citationMetadata?.citationSources.map((source: { uri?: string | null }) => ({\r\n            uri: source.uri ?? '',\r\n            title: '' // Title is not directly available in this structure\r\n        })) || [];\r\n\r\n\r\n        return { ...parsedPlan, groundingAttribution: attributions };\r\n\r\n    } catch (error) {\r\n        console.error(\"Error generating plan:\", error);\r\n        throw new Error(\"Failed to generate travel plan from the model.\");\r\n    }\r\n};\r\n"],"names":[],"mappings":";;;;;;IAgCa,eAAA,WAAA,GAAA,CAAA,GAAA,sNAAA,CAAA,wBAAA,EAAA,8CAAA,sNAAA,CAAA,aAAA,EAAA,KAAA,GAAA,sNAAA,CAAA,mBAAA,EAAA","debugId":null}},
    {"offset": {"line": 664, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dibuj/Documents/Voaya/client/src/app/actions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { ChatMessage } from '@/types';\r\n\r\ninterface ProcessResult {\r\n  success: boolean;\r\n  message: string;\r\n  data?: any;\r\n}\r\n\r\nexport async function processAndSendData(\r\n  history: ChatMessage[],\r\n  category: 'flights' | 'hotels' | 'experiences'\r\n): Promise<ProcessResult> {\r\n\r\n  switch (category) {\r\n    case 'flights':\r\n      try {\r\n        // Enviar el historial del chat al webhook de n8n para extracción de datos\r\n        console.log(\"Enviando historial del chat a n8n para extracción...\");\r\n\r\n        const webhookUrl = 'https://n8n.voaya.es/webhook/flight-search';\r\n        console.log(`Enviando datos a ${webhookUrl}...`);\r\n\r\n        const response = await fetch(webhookUrl, {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n          },\r\n          body: JSON.stringify({\r\n            chatHistory: history,\r\n            category: 'flights',\r\n            timestamp: new Date().toISOString(),\r\n          }),\r\n        });\r\n\r\n        if (!response.ok) {\r\n          const errorBody = await response.text();\r\n          console.error(`Error del webhook: ${response.status} ${response.statusText}`, errorBody);\r\n          return { success: false, message: `El servidor de Voaya respondió con un error: ${response.statusText}` };\r\n        }\r\n\r\n        const responseData = await response.json();\r\n        console.log(\"Respuesta del webhook:\", responseData);\r\n\r\n        return { success: true, message: \"¡Búsqueda de vuelos iniciada con éxito!\", data: responseData };\r\n\r\n      } catch (error) {\r\n        console.error(\"Error procesando la solicitud de vuelos:\", error);\r\n        const errorMessage = error instanceof Error ? error.message : \"Ocurrió un error desconocido.\";\r\n        return { success: false, message: `Error interno: ${errorMessage}` };\r\n      }\r\n\r\n    case 'hotels':\r\n      // TODO: Implementar lógica para hoteles\r\n      console.log(\"Procesamiento para 'hoteles' aún no implementado.\");\r\n      return { success: false, message: \"La categoría 'hoteles' aún no está implementada.\" };\r\n\r\n    case 'experiences':\r\n      // TODO: Implementar lógica para experiencias\r\n      console.log(\"Procesamiento para 'experiencias' aún no implementado.\");\r\n      return { success: false, message: \"La categoría 'experiencias' aún no está implementada.\" };\r\n\r\n    default:\r\n      console.warn(`Categoría desconocida: ${category}`);\r\n      return { success: false, message: `La categoría '${category}' no es válida.` };\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;IAUsB,qBAAA,WAAA,GAAA,CAAA,GAAA,sNAAA,CAAA,wBAAA,EAAA,8CAAA,sNAAA,CAAA,aAAA,EAAA,KAAA,GAAA,sNAAA,CAAA,mBAAA,EAAA","debugId":null}},
    {"offset": {"line": 677, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dibuj/Documents/Voaya/client/src/app/plan/page.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useUser } from '@/firebase';\r\nimport { useRouter, useSearchParams } from 'next/navigation';\r\nimport { useEffect, useState, useMemo, Suspense } from 'react';\r\nimport { Loader } from '@/components/ui/loader';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Search, Plane, Hotel, Mountain } from 'lucide-react';\r\nimport { AnimatePresence, motion } from 'framer-motion';\r\nimport ChatView from '@/components/chat/chat-view';\r\nimport { TravelPlan, TravelBrief } from '@/types';\r\nimport { generatePlan } from '@/app/actions/chat-actions';\r\nimport { processAndSendData } from '@/app/actions';\r\nimport { getUserIdFromCookie, getChatIdFromCookie, saveChatIdToCookie } from '@/lib/cookies';\r\nimport { ApiService } from '@/services/api';\r\n\r\ntype SearchCategory = 'flights' | 'hotels' | 'experiences';\r\n\r\nfunction PlanPageComponent() {\r\n  const { user, isUserLoading } = useUser();\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n\r\n  const [tripDescription, setTripDescription] = useState('');\r\n  const [isCreatingChat, setIsCreatingChat] = useState(false);\r\n  const [selectedCategories, setSelectedCategories] = useState<Set<SearchCategory>>(new Set(['flights'] as SearchCategory[]));\r\n  const [isSendingToWebhook, setIsSendingToWebhook] = useState(false);\r\n\r\n  // State for the view\r\n  const [currentView, setCurrentView] = useState<'form' | 'chat' | 'plan'>('form');\r\n  const [travelPlan, setTravelPlan] = useState<TravelPlan | null>(null);\r\n  const [planError, setPlanError] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    const chatIdFromUrl = searchParams?.get('chatId');\r\n    if (chatIdFromUrl) {\r\n      // This logic can be adapted if we still want to link to old chats\r\n      // For now, starting fresh is the main flow.\r\n    }\r\n  }, [searchParams]);\r\n\r\n  useEffect(() => {\r\n    if (!isUserLoading && !user) {\r\n      router.push('/login');\r\n    }\r\n  }, [user, isUserLoading, router]);\r\n\r\n  const handleSearchTypeToggle = (category: SearchCategory) => {\r\n    setSelectedCategories(prev => {\r\n      const newSelection = new Set(prev);\r\n      if (newSelection.has(category)) {\r\n        if (newSelection.size > 1) {\r\n          newSelection.delete(category);\r\n        }\r\n      } else {\r\n        newSelection.add(category);\r\n      }\r\n      return newSelection;\r\n    });\r\n  };\r\n\r\n  const placeholders: { [key: string]: string } = {\r\n    'flights': \"'Un vuelo a Bali para 2 personas en diciembre'\",\r\n    'hotels': \"'Hoteles de 5 estrellas en Roma con piscina'\",\r\n    'experiences': \"'Ruta del vino en la Toscana'\",\r\n    'flights,hotels': \"'Vuelo y hotel para una escapada a París el próximo fin de semana'\",\r\n    'flights,experiences': \"'Vuelos a Costa Rica y un tour por la selva para ver perezosos'\",\r\n    'hotels,experiences': \"'Hotel boutique en Kioto y una clase de ceremonia del té'\",\r\n    'flights,hotels,experiences': \"'Un viaje completo a Japón para 3 personas en verano'\",\r\n  };\r\n\r\n  const placeholderKey = useMemo(() => {\r\n    const sortedCategories = Array.from(selectedCategories).sort().join(',');\r\n    return placeholders[sortedCategories] || placeholders['flights,hotels,experiences'];\r\n  }, [selectedCategories]);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!tripDescription) return;\r\n\r\n    console.log('[PlanPage] handleSubmit called with description:', tripDescription);\r\n    setIsCreatingChat(true);\r\n\r\n    try {\r\n      const userId = getUserIdFromCookie();\r\n      console.log('[PlanPage] userId from cookie:', userId);\r\n\r\n      if (!userId) {\r\n        console.error('[PlanPage] No userId found in cookies');\r\n        alert('Por favor, inicia sesión primero');\r\n        setIsCreatingChat(false);\r\n        return;\r\n      }\r\n\r\n      const categories = Array.from(selectedCategories);\r\n      console.log('[PlanPage] Calling ApiService.startChat with:', { userId, categories });\r\n\r\n      // Create chat on server first\r\n      const chatResponse = await ApiService.startChat(userId, categories);\r\n      console.log('[PlanPage] chatResponse received:', chatResponse);\r\n\r\n      if (!chatResponse || !chatResponse.chatId) {\r\n        console.error('[PlanPage] No chatId in response:', chatResponse);\r\n        alert('Error al crear el chat: respuesta inválida del servidor');\r\n        setIsCreatingChat(false);\r\n        return;\r\n      }\r\n\r\n      const newChatId = chatResponse.chatId;\r\n      console.log('[PlanPage] newChatId:', newChatId);\r\n\r\n      // Save chatId to cookies\r\n      saveChatIdToCookie(newChatId);\r\n      console.log('[PlanPage] chatId saved to cookies');\r\n\r\n      // Now change view to chat\r\n      console.log('[PlanPage] Changing view to chat');\r\n      setCurrentView('chat');\r\n    } catch (error) {\r\n      console.error('[PlanPage] Failed to create chat:', error);\r\n      const errorMessage = error instanceof Error ? error.message : 'Error desconocido';\r\n      alert(`Error al crear el chat: ${errorMessage}`);\r\n      setIsCreatingChat(false);\r\n    } finally {\r\n      setIsCreatingChat(false);\r\n    }\r\n  };\r\n\r\n  const handleChatComplete = async (brief: TravelBrief) => {\r\n    // Si la única categoría es \"flights\", llamamos directamente al webhook.\r\n    if (selectedCategories.size === 1 && selectedCategories.has('flights')) {\r\n      setIsSendingToWebhook(true);\r\n      setPlanError(null);\r\n\r\n      const result = await processAndSendData(brief.chatHistory, 'flights');\r\n\r\n      if (result.success) {\r\n        // Aquí podrías mostrar un mensaje de éxito o redirigir al usuario.\r\n        // Por ahora, lo mostraremos en un alert y resetearemos el formulario.\r\n        alert(result.message);\r\n        setTripDescription('');\r\n        setCurrentView('form');\r\n      } else {\r\n        setPlanError(result.message);\r\n      }\r\n      setIsSendingToWebhook(false);\r\n      return;\r\n    }\r\n\r\n    // Para cualquier otra combinación de categorías, usamos el flujo de generación de plan.\r\n    setCurrentView('plan');\r\n    try {\r\n      const plan = await generatePlan(brief, null); // userLocation is null for ahora\r\n      setTravelPlan(plan);\r\n    } catch (e) {\r\n      console.error(e);\r\n      const errorMessage = e instanceof Error ? e.message : \"An unknown error occurred while generating the plan.\";\r\n      setPlanError(errorMessage);\r\n    }\r\n  };\r\n\r\n  if (isUserLoading || isSendingToWebhook || isCreatingChat) {\r\n    return (\r\n      <div className=\"flex min-h-screen items-center justify-center\">\r\n        <Loader />\r\n        {isSendingToWebhook && <p className=\"ml-4\">Enviando tu solicitud de vuelo...</p>}\r\n        {isCreatingChat && <p className=\"ml-4\">Creando tu chat...</p>}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) {\r\n    return null;\r\n  }\r\n\r\n  if (currentView === 'chat') {\r\n    return (\r\n      <div className=\"py-8 md:py-12 min-h-screen bg-gray-50/50\">\r\n        <ChatView\r\n          onChatComplete={handleChatComplete}\r\n          error={null}\r\n          initialQuery={tripDescription}\r\n          selectedCategories={selectedCategories}\r\n          userId={user.uid}\r\n          chatId={getChatIdFromCookie() || undefined}\r\n        />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (currentView === 'plan') {\r\n    if (planError) {\r\n      return <div className=\"text-center py-10\"><h2 className=\"text-destructive\">Error generating plan</h2><p>{planError}</p></div>;\r\n    }\r\n    if (!travelPlan) {\r\n      return <div className=\"flex min-h-screen items-center justify-center\"><Loader /> <p className=\"ml-4\">Generating your travel plan...</p></div>;\r\n    }\r\n    // A simple display for the travel plan. This can be expanded into its own component.\r\n    return (\r\n      <div className=\"container mx-auto px-4 py-8\">\r\n        <h1 className=\"text-3xl font-bold\">Your Travel Plan to {travelPlan.summary.destination}</h1>\r\n        <pre className=\"mt-4 p-4 bg-muted rounded-lg whitespace-pre-wrap\">{JSON.stringify(travelPlan, null, 2)}</pre>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Initial Form View\r\n  const searchOptions = [\r\n    { id: 'flights', label: 'Vuelos', icon: <Plane className=\"mr-2 h-4 w-4\" /> },\r\n    { id: 'hotels', label: 'Hoteles', icon: <Hotel className=\"mr-2 h-4 w-4\" /> },\r\n    { id: 'experiences', label: 'Experiencias', icon: <Mountain className=\"mr-2 h-4 w-4\" /> },\r\n  ] as const;\r\n\r\n  return (\r\n    <div className=\"flex flex-col items-center justify-center min-h-[calc(100vh-128px)] bg-background text-center px-4\">\r\n      <div className=\"w-full max-w-2xl\">\r\n        <h1 className=\"text-3xl md:text-4xl font-bold text-foreground mb-4\">\r\n          ¡Hola! Soy Voaya. Describe el viaje de tus sueños y te ayudaré a planificarlo.\r\n        </h1>\r\n\r\n        <div className=\"flex justify-center gap-2 mb-6\">\r\n          {searchOptions.map((option) => (\r\n            <Button\r\n              key={option.id}\r\n              variant={selectedCategories.has(option.id) ? 'default' : 'outline'}\r\n              onClick={() => handleSearchTypeToggle(option.id)}\r\n              className=\"rounded-full transition-all duration-300 ease-in-out hover:shadow-lg\"\r\n            >\r\n              {option.icon}\r\n              {option.label}\r\n            </Button>\r\n          ))}\r\n        </div>\r\n\r\n        <form onSubmit={handleSubmit} className=\"w-full space-y-4\">\r\n          <div className=\"relative\">\r\n            <Search className=\"absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground z-10\" />\r\n            <AnimatePresence mode=\"wait\">\r\n              <motion.div\r\n                key={placeholderKey}\r\n                initial={{ opacity: 0, y: -10 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                exit={{ opacity: 0, y: 10 }}\r\n                transition={{ duration: 0.2 }}\r\n                className=\"w-full\"\r\n              >\r\n                <Input\r\n                  type=\"text\"\r\n                  value={tripDescription}\r\n                  onChange={(e) => setTripDescription(e.target.value)}\r\n                  placeholder={placeholderKey}\r\n                  className=\"relative h-14 pl-12 pr-4 text-base rounded-full shadow-lg bg-card border-transparent focus:ring-2 focus:ring-ring transition-transform duration-300 ease-in-out hover:scale-[1.02] placeholder:text-muted-foreground\"\r\n                  autoFocus\r\n                />\r\n              </motion.div>\r\n            </AnimatePresence>\r\n          </div>\r\n          <Button\r\n            type=\"submit\"\r\n            size=\"lg\"\r\n            className=\"h-12 px-10 rounded-full bg-accent text-accent-foreground hover:bg-accent/90 transition-transform duration-300 ease-in-out disabled:scale-100 enabled:hover:scale-105\"\r\n            disabled={isCreatingChat || !tripDescription}\r\n          >\r\n            {isCreatingChat ? <Loader /> : 'Enviar'}\r\n          </Button>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n\r\nexport default function PlanPage() {\r\n  return (\r\n    <Suspense fallback={<div className=\"flex min-h-screen items-center justify-center\"><Loader /></div>}>\r\n      <PlanPageComponent />\r\n    </Suspense>\r\n  )\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAfA;;;;;;;;;;;;;;;AAmBA,SAAS;IACP,MAAM,EAAE,IAAI,EAAE,aAAa,EAAE,GAAG,CAAA,GAAA,mIAAA,CAAA,UAAO,AAAD;IACtC,MAAM,SAAS,CAAA,GAAA,kIAAA,CAAA,YAAS,AAAD;IACvB,MAAM,eAAe,CAAA,GAAA,kIAAA,CAAA,kBAAe,AAAD;IAEnC,MAAM,CAAC,iBAAiB,mBAAmB,GAAG,CAAA,GAAA,qMAAA,CAAA,WAAQ,AAAD,EAAE;IACvD,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,CAAA,GAAA,qMAAA,CAAA,WAAQ,AAAD,EAAE;IACrD,MAAM,CAAC,oBAAoB,sBAAsB,GAAG,CAAA,GAAA,qMAAA,CAAA,WAAQ,AAAD,EAAuB,IAAI,IAAI;QAAC;KAAU;IACrG,MAAM,CAAC,oBAAoB,sBAAsB,GAAG,CAAA,GAAA,qMAAA,CAAA,WAAQ,AAAD,EAAE;IAE7D,qBAAqB;IACrB,MAAM,CAAC,aAAa,eAAe,GAAG,CAAA,GAAA,qMAAA,CAAA,WAAQ,AAAD,EAA4B;IACzE,MAAM,CAAC,YAAY,cAAc,GAAG,CAAA,GAAA,qMAAA,CAAA,WAAQ,AAAD,EAAqB;IAChE,MAAM,CAAC,WAAW,aAAa,GAAG,CAAA,GAAA,qMAAA,CAAA,WAAQ,AAAD,EAAiB;IAE1D,CAAA,GAAA,qMAAA,CAAA,YAAS,AAAD,EAAE;QACR,MAAM,gBAAgB,cAAc,IAAI;QACxC,IAAI,eAAe;QACjB,kEAAkE;QAClE,4CAA4C;QAC9C;IACF,GAAG;QAAC;KAAa;IAEjB,CAAA,GAAA,qMAAA,CAAA,YAAS,AAAD,EAAE;QACR,IAAI,CAAC,iBAAiB,CAAC,MAAM;YAC3B,OAAO,IAAI,CAAC;QACd;IACF,GAAG;QAAC;QAAM;QAAe;KAAO;IAEhC,MAAM,yBAAyB,CAAC;QAC9B,sBAAsB,CAAA;YACpB,MAAM,eAAe,IAAI,IAAI;YAC7B,IAAI,aAAa,GAAG,CAAC,WAAW;gBAC9B,IAAI,aAAa,IAAI,GAAG,GAAG;oBACzB,aAAa,MAAM,CAAC;gBACtB;YACF,OAAO;gBACL,aAAa,GAAG,CAAC;YACnB;YACA,OAAO;QACT;IACF;IAEA,MAAM,eAA0C;QAC9C,WAAW;QACX,UAAU;QACV,eAAe;QACf,kBAAkB;QAClB,uBAAuB;QACvB,sBAAsB;QACtB,8BAA8B;IAChC;IAEA,MAAM,iBAAiB,CAAA,GAAA,qMAAA,CAAA,UAAO,AAAD,EAAE;QAC7B,MAAM,mBAAmB,MAAM,IAAI,CAAC,oBAAoB,IAAI,GAAG,IAAI,CAAC;QACpE,OAAO,YAAY,CAAC,iBAAiB,IAAI,YAAY,CAAC,6BAA6B;IACrF,GAAG;QAAC;KAAmB;IAEvB,MAAM,eAAe,OAAO;QAC1B,EAAE,cAAc;QAChB,IAAI,CAAC,iBAAiB;QAEtB,QAAQ,GAAG,CAAC,oDAAoD;QAChE,kBAAkB;QAElB,IAAI;YACF,MAAM,SAAS,CAAA,GAAA,+HAAA,CAAA,sBAAmB,AAAD;YACjC,QAAQ,GAAG,CAAC,kCAAkC;YAE9C,IAAI,CAAC,QAAQ;gBACX,QAAQ,KAAK,CAAC;gBACd,MAAM;gBACN,kBAAkB;gBAClB;YACF;YAEA,MAAM,aAAa,MAAM,IAAI,CAAC;YAC9B,QAAQ,GAAG,CAAC,iDAAiD;gBAAE;gBAAQ;YAAW;YAElF,8BAA8B;YAC9B,MAAM,eAAe,MAAM,gIAAA,CAAA,aAAU,CAAC,SAAS,CAAC,QAAQ;YACxD,QAAQ,GAAG,CAAC,qCAAqC;YAEjD,IAAI,CAAC,gBAAgB,CAAC,aAAa,MAAM,EAAE;gBACzC,QAAQ,KAAK,CAAC,qCAAqC;gBACnD,MAAM;gBACN,kBAAkB;gBAClB;YACF;YAEA,MAAM,YAAY,aAAa,MAAM;YACrC,QAAQ,GAAG,CAAC,yBAAyB;YAErC,yBAAyB;YACzB,CAAA,GAAA,+HAAA,CAAA,qBAAkB,AAAD,EAAE;YACnB,QAAQ,GAAG,CAAC;YAEZ,0BAA0B;YAC1B,QAAQ,GAAG,CAAC;YACZ,eAAe;QACjB,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,qCAAqC;YACnD,MAAM,eAAe,iBAAiB,QAAQ,MAAM,OAAO,GAAG;YAC9D,MAAM,CAAC,wBAAwB,EAAE,cAAc;YAC/C,kBAAkB;QACpB,SAAU;YACR,kBAAkB;QACpB;IACF;IAEA,MAAM,qBAAqB,OAAO;QAChC,wEAAwE;QACxE,IAAI,mBAAmB,IAAI,KAAK,KAAK,mBAAmB,GAAG,CAAC,YAAY;YACtE,sBAAsB;YACtB,aAAa;YAEb,MAAM,SAAS,MAAM,CAAA,GAAA,4JAAA,CAAA,qBAAkB,AAAD,EAAE,MAAM,WAAW,EAAE;YAE3D,IAAI,OAAO,OAAO,EAAE;gBAClB,mEAAmE;gBACnE,sEAAsE;gBACtE,MAAM,OAAO,OAAO;gBACpB,mBAAmB;gBACnB,eAAe;YACjB,OAAO;gBACL,aAAa,OAAO,OAAO;YAC7B;YACA,sBAAsB;YACtB;QACF;QAEA,wFAAwF;QACxF,eAAe;QACf,IAAI;YACF,MAAM,OAAO,MAAM,CAAA,GAAA,uKAAA,CAAA,eAAY,AAAD,EAAE,OAAO,OAAO,iCAAiC;YAC/E,cAAc;QAChB,EAAE,OAAO,GAAG;YACV,QAAQ,KAAK,CAAC;YACd,MAAM,eAAe,aAAa,QAAQ,EAAE,OAAO,GAAG;YACtD,aAAa;QACf;IACF;IAEA,IAAI,iBAAiB,sBAAsB,gBAAgB;QACzD,qBACE,8OAAC;YAAI,WAAU;;8BACb,8OAAC,4IAAA,CAAA,SAAM;;;;;gBACN,oCAAsB,8OAAC;oBAAE,WAAU;8BAAO;;;;;;gBAC1C,gCAAkB,8OAAC;oBAAE,WAAU;8BAAO;;;;;;;;;;;;IAG7C;IAEA,IAAI,CAAC,MAAM;QACT,OAAO;IACT;IAEA,IAAI,gBAAgB,QAAQ;QAC1B,qBACE,8OAAC;YAAI,WAAU;sBACb,cAAA,8OAAC,oJAAA,CAAA,UAAQ;gBACP,gBAAgB;gBAChB,OAAO;gBACP,cAAc;gBACd,oBAAoB;gBACpB,QAAQ,KAAK,GAAG;gBAChB,QAAQ,CAAA,GAAA,+HAAA,CAAA,sBAAmB,AAAD,OAAO;;;;;;;;;;;IAIzC;IAEA,IAAI,gBAAgB,QAAQ;QAC1B,IAAI,WAAW;YACb,qBAAO,8OAAC;gBAAI,WAAU;;kCAAoB,8OAAC;wBAAG,WAAU;kCAAmB;;;;;;kCAA0B,8OAAC;kCAAG;;;;;;;;;;;;QAC3G;QACA,IAAI,CAAC,YAAY;YACf,qBAAO,8OAAC;gBAAI,WAAU;;kCAAgD,8OAAC,4IAAA,CAAA,SAAM;;;;;oBAAG;kCAAC,8OAAC;wBAAE,WAAU;kCAAO;;;;;;;;;;;;QACvG;QACA,qFAAqF;QACrF,qBACE,8OAAC;YAAI,WAAU;;8BACb,8OAAC;oBAAG,WAAU;;wBAAqB;wBAAqB,WAAW,OAAO,CAAC,WAAW;;;;;;;8BACtF,8OAAC;oBAAI,WAAU;8BAAoD,KAAK,SAAS,CAAC,YAAY,MAAM;;;;;;;;;;;;IAG1G;IAEA,oBAAoB;IACpB,MAAM,gBAAgB;QACpB;YAAE,IAAI;YAAW,OAAO;YAAU,oBAAM,8OAAC,oMAAA,CAAA,QAAK;gBAAC,WAAU;;;;;;QAAkB;QAC3E;YAAE,IAAI;YAAU,OAAO;YAAW,oBAAM,8OAAC,oMAAA,CAAA,QAAK;gBAAC,WAAU;;;;;;QAAkB;QAC3E;YAAE,IAAI;YAAe,OAAO;YAAgB,oBAAM,8OAAC,0MAAA,CAAA,WAAQ;gBAAC,WAAU;;;;;;QAAkB;KACzF;IAED,qBACE,8OAAC;QAAI,WAAU;kBACb,cAAA,8OAAC;YAAI,WAAU;;8BACb,8OAAC;oBAAG,WAAU;8BAAsD;;;;;;8BAIpE,8OAAC;oBAAI,WAAU;8BACZ,cAAc,GAAG,CAAC,CAAC,uBAClB,8OAAC,4IAAA,CAAA,SAAM;4BAEL,SAAS,mBAAmB,GAAG,CAAC,OAAO,EAAE,IAAI,YAAY;4BACzD,SAAS,IAAM,uBAAuB,OAAO,EAAE;4BAC/C,WAAU;;gCAET,OAAO,IAAI;gCACX,OAAO,KAAK;;2BANR,OAAO,EAAE;;;;;;;;;;8BAWpB,8OAAC;oBAAK,UAAU;oBAAc,WAAU;;sCACtC,8OAAC;4BAAI,WAAU;;8CACb,8OAAC,sMAAA,CAAA,SAAM;oCAAC,WAAU;;;;;;8CAClB,8OAAC,mMAAA,CAAA,kBAAe;oCAAC,MAAK;8CACpB,cAAA,8OAAC,oMAAA,CAAA,SAAM,CAAC,GAAG;wCAET,SAAS;4CAAE,SAAS;4CAAG,GAAG,CAAC;wCAAG;wCAC9B,SAAS;4CAAE,SAAS;4CAAG,GAAG;wCAAE;wCAC5B,MAAM;4CAAE,SAAS;4CAAG,GAAG;wCAAG;wCAC1B,YAAY;4CAAE,UAAU;wCAAI;wCAC5B,WAAU;kDAEV,cAAA,8OAAC,2IAAA,CAAA,QAAK;4CACJ,MAAK;4CACL,OAAO;4CACP,UAAU,CAAC,IAAM,mBAAmB,EAAE,MAAM,CAAC,KAAK;4CAClD,aAAa;4CACb,WAAU;4CACV,SAAS;;;;;;uCAbN;;;;;;;;;;;;;;;;sCAkBX,8OAAC,4IAAA,CAAA,SAAM;4BACL,MAAK;4BACL,MAAK;4BACL,WAAU;4BACV,UAAU,kBAAkB,CAAC;sCAE5B,+BAAiB,8OAAC,4IAAA,CAAA,SAAM;;;;uCAAM;;;;;;;;;;;;;;;;;;;;;;;AAM3C;AAGe,SAAS;IACtB,qBACE,8OAAC,qMAAA,CAAA,WAAQ;QAAC,wBAAU,8OAAC;YAAI,WAAU;sBAAgD,cAAA,8OAAC,4IAAA,CAAA,SAAM;;;;;;;;;;kBACxF,cAAA,8OAAC;;;;;;;;;;AAGP","debugId":null}}]
}